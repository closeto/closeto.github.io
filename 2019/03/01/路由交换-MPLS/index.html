<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>多协议标签交换—MPLS | 欢迎来到closeto的博客</title>
  <meta name="keywords" content=" 2019 ">
  <meta name="description" content="多协议标签交换—MPLS | 欢迎来到closeto的博客">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="一、准备工作下载对应版本的内核文件    hostnamectl    Kernel官网下载地址：https:&#x2F;&#x2F;kernel.org&#x2F; 环境Centos9 &amp; 准备工作CentOS-Stream-9-latest-x86_64-dvd1-miniyum install -y gcc ncurses-devel *ncurses bison flex libelf-dev libelf-d">
<meta property="og:type" content="article">
<meta property="og:title" content="Busybox搭建最小Linux">
<meta property="og:url" content="https://closeto.github.io/2023/03/10/busybox%E6%90%AD%E5%BB%BA%E6%9C%80%E5%B0%8FLinux/index.html">
<meta property="og:site_name" content="欢迎来到closeto的博客">
<meta property="og:description" content="一、准备工作下载对应版本的内核文件    hostnamectl    Kernel官网下载地址：https:&#x2F;&#x2F;kernel.org&#x2F; 环境Centos9 &amp; 准备工作CentOS-Stream-9-latest-x86_64-dvd1-miniyum install -y gcc ncurses-devel *ncurses bison flex libelf-dev libelf-d">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-03-10T04:30:00.000Z">
<meta property="article:author" content="closeto">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="2023">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/ico.png">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 6.3.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/user.png"/>
</a>
<div class="author">
    <span>closeto</span>
</div>

<div class="icon">
    
        
            <a title="github"
               href="https://github.com/closeto"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="email"
               href="mailto:vou0515@gmail.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(50)</small>
            
        </div>
    </li>
    
        
            
                
    <li>
        <div data-rel="Web安全">
            
            Web安全
            <small>(17)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="内网安全">
            
            内网安全
            <small>(11)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Windows相关">
            
            Windows相关
            <small>(4)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Linux相关">
            
            Linux相关
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="数字通信">
            <i class="fold iconfont icon-right"></i>
            数字通信
            <small>(12)</small>
        </div>
        
            <ul class="sub hide">
                
                    
    <li>
        <div data-rel="数字通信&lt;---&gt;网络基础">
            
            网络基础
            <small>(1)</small>
        </div>
        
    </li>

                
            </ul>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="其它">
            
            其它
            <small>(3)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="考证学习">
            
            考证学习
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
    </div>
    <div>
        
            <a class="about  "
               target="_blank"
                    
               href="https://github.com/closeto">关于</a>
        
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="50">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="/url">名字列表</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>2019</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>2020</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>2021</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>2022</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>2023</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>内网</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>软考</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>渗透测试</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>文件格式</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>中级</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Bin</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Linux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ShellCode</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Web</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Windows</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="全部文章 Linux相关 "
           href="/2023/03/10/busybox%E6%90%AD%E5%BB%BA%E6%9C%80%E5%B0%8FLinux/"
           data-tag="Linux,2023"
           data-author="" >
            <span class="post-title" title="Busybox搭建最小Linux">Busybox搭建最小Linux</span>
            <span class="post-date" title="2023-03-10 12:30:00">2023/03/10</span>
        </a>
        
        
        <a  class="全部文章 其它 "
           href="/2022/07/19/Nginx%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F/"
           data-tag="2022"
           data-author="" >
            <span class="post-title" title="Nginx日志格式">Nginx日志格式</span>
            <span class="post-date" title="2022-07-19 00:00:00">2022/07/19</span>
        </a>
        
        
        <a  class="全部文章 其它 "
           href="/2022/05/07/UTF-8%E9%9D%9E%E6%9C%80%E7%9F%AD%E5%BD%A2%E5%BC%8F&%E7%BC%96%E7%A0%81%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/"
           data-tag="2022"
           data-author="" >
            <span class="post-title" title="UTF8编码安全">UTF8编码安全</span>
            <span class="post-date" title="2022-05-07 00:00:00">2022/05/07</span>
        </a>
        
        
        <a  class="全部文章 Windows相关 "
           href="/2022/04/10/ShellCode%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E2%80%94%E7%9B%B8%E9%81%87/"
           data-tag="2022,ShellCode,Bin"
           data-author="" >
            <span class="post-title" title="ShellCode入门到放弃—相遇">ShellCode入门到放弃—相遇</span>
            <span class="post-date" title="2022-04-10 19:30:00">2022/04/10</span>
        </a>
        
        
        <a  class="全部文章 Windows相关 "
           href="/2022/04/10/PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E2%80%94%E7%AE%80%E4%BB%8B/"
           data-tag="2022,文件格式"
           data-author="" >
            <span class="post-title" title="PE文件格式—简介">PE文件格式—简介</span>
            <span class="post-date" title="2022-04-10 10:48:36">2022/04/10</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2022/03/10/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-Redis%E6%9C%AA%E6%8E%88%E6%9D%83/"
           data-tag="2022,内网,渗透测试"
           data-author="" >
            <span class="post-title" title="Redis未授权">Redis未授权</span>
            <span class="post-date" title="2022-03-10 14:30:00">2022/03/10</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2022/03/01/WL%E7%AB%AF%E5%8F%A3%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91/"
           data-tag="2022,内网,Windows"
           data-author="" >
            <span class="post-title" title="WL端口流量转发">WL端口流量转发</span>
            <span class="post-date" title="2022-03-01 00:00:00">2022/03/01</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2022/02/19/Linux%E7%97%95%E8%BF%B9%E6%93%A6%E9%99%A4/"
           data-tag="2022,内网,渗透测试,Linux"
           data-author="" >
            <span class="post-title" title="Linux痕迹擦除">Linux痕迹擦除</span>
            <span class="post-date" title="2022-02-19 00:00:00">2022/02/19</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2022/02/18/Windows%E7%97%95%E8%BF%B9%E6%93%A6%E9%99%A4/"
           data-tag="2022,内网,渗透测试,Windows"
           data-author="" >
            <span class="post-title" title="Windows痕迹擦除">Windows痕迹擦除</span>
            <span class="post-date" title="2022-02-18 00:00:00">2022/02/18</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2022/02/14/Windows%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"
           data-tag="2022,内网,渗透测试,Windows"
           data-author="" >
            <span class="post-title" title="Windows信息收集">Windows信息收集</span>
            <span class="post-date" title="2022-02-14 00:00:00">2022/02/14</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2022/02/13/Linux%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"
           data-tag="2022,内网,渗透测试,Linux"
           data-author="" >
            <span class="post-title" title="Linux信息收集">Linux信息收集</span>
            <span class="post-date" title="2022-02-13 00:00:00">2022/02/13</span>
        </a>
        
        
        <a  class="全部文章 Windows相关 "
           href="/2022/01/18/ShellCode%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E2%80%94%E7%9B%B8%E5%BC%83/"
           data-tag="2022,ShellCode,Bin"
           data-author="" >
            <span class="post-title" title="ShellCode入门到放弃—相弃">ShellCode入门到放弃—相弃</span>
            <span class="post-date" title="2022-01-18 17:30:00">2022/01/18</span>
        </a>
        
        
        <a  class="全部文章 考证学习 "
           href="/2022/01/18/%E8%BD%AF%E8%80%83%E4%B8%AD%E7%BA%A7%E2%80%94%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%B7%A5%E7%A8%8B%E5%B8%88/"
           data-tag="2023,软考,中级"
           data-author="" >
            <span class="post-title" title="软考中级—信息安全工程师">软考中级—信息安全工程师</span>
            <span class="post-date" title="2022-01-18 14:30:00">2022/01/18</span>
        </a>
        
        
        <a  class="全部文章 Windows相关 "
           href="/2022/01/15/ShellCode%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E2%80%94%E7%9B%B8%E7%9F%A5/"
           data-tag="2022,ShellCode,Bin"
           data-author="" >
            <span class="post-title" title="ShellCode入门到放弃—相知">ShellCode入门到放弃—相知</span>
            <span class="post-date" title="2022-01-15 12:12:12">2022/01/15</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2021/11/19/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-Linux%E6%8F%90%E6%9D%83/"
           data-tag="内网,渗透测试,2021"
           data-author="" >
            <span class="post-title" title="Linux提权">Linux提权</span>
            <span class="post-date" title="2021-11-19 14:30:00">2021/11/19</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2021/11/10/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F_%E5%AF%86%E7%A0%81%E6%8F%90%E5%8F%96/"
           data-tag="内网,渗透测试,2021"
           data-author="" >
            <span class="post-title" title="终端管理工具密码获取">终端管理工具密码获取</span>
            <span class="post-date" title="2021-11-10 14:30:00">2021/11/10</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2021/11/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-Linux%E5%8F%8D%E5%BC%B9Shell/"
           data-tag="内网,渗透测试,2021"
           data-author="" >
            <span class="post-title" title="Linux反弹Shell">Linux反弹Shell</span>
            <span class="post-date" title="2021-11-04 14:30:00">2021/11/04</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2021/10/19/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-%E6%B5%81%E9%87%8F%E7%89%B9%E5%BE%81NPS%E3%80%81FRP/"
           data-tag="内网,渗透测试,2021"
           data-author="" >
            <span class="post-title" title="流量特征NPS、FRP">流量特征NPS、FRP</span>
            <span class="post-date" title="2021-10-19 14:30:00">2021/10/19</span>
        </a>
        
        
        <a  class="全部文章 内网安全 "
           href="/2021/09/10/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8-docker%E6%9C%AA%E6%8E%88%E6%9D%83/"
           data-tag="内网,渗透测试,2021"
           data-author="" >
            <span class="post-title" title="docker未授权">docker未授权</span>
            <span class="post-date" title="2021-09-10 14:30:00">2021/09/10</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/07/25/web%E5%AE%89%E5%85%A8-Xpath%E6%B3%A8%E5%85%A5/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="Xpath注入">Xpath注入</span>
            <span class="post-date" title="2021-07-25 00:00:00">2021/07/25</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/07/16/Web%E5%AE%89%E5%85%A8-SQL%E6%B3%A8%E5%85%A5/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="SQL注入">SQL注入</span>
            <span class="post-date" title="2021-07-16 00:00:00">2021/07/16</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/06/19/Web%E5%AE%89%E5%85%A8-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="文件上传漏洞">文件上传漏洞</span>
            <span class="post-date" title="2021-06-19 00:00:00">2021/06/19</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/06/08/Web%E5%AE%89%E5%85%A8-PHP%E5%BA%8F%E5%88%97%E5%8C%96&%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="PHP序列化与反序列化">PHP序列化与反序列化</span>
            <span class="post-date" title="2021-06-08 00:00:00">2021/06/08</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/06/04/Web%E5%AE%89%E5%85%A8-SSI%E6%B3%A8%E5%85%A5/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="SSI注入">SSI注入</span>
            <span class="post-date" title="2021-06-04 00:00:00">2021/06/04</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/2021/06/02/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"
           data-tag="Linux,2021"
           data-author="" >
            <span class="post-title" title="Docker常用命令">Docker常用命令</span>
            <span class="post-date" title="2021-06-02 00:00:00">2021/06/02</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/05/25/Web%E5%AE%89%E5%85%A8-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="文件包含漏洞">文件包含漏洞</span>
            <span class="post-date" title="2021-05-25 00:00:00">2021/05/25</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/04/19/Web%E5%AE%89%E5%85%A8-%E8%B6%8A%E6%9D%83/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="越权">越权</span>
            <span class="post-date" title="2021-04-19 00:00:00">2021/04/19</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/04/06/Web%E5%AE%89%E5%85%A8-Xxe/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="XXE">XXE</span>
            <span class="post-date" title="2021-04-06 00:00:00">2021/04/06</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/04/05/Web%E5%AE%89%E5%85%A8-%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="文件下载漏洞">文件下载漏洞</span>
            <span class="post-date" title="2021-04-05 00:00:00">2021/04/05</span>
        </a>
        
        
        <a  class="全部文章 其它 "
           href="/2021/04/02/%E5%B8%B8%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"
           data-tag="2021"
           data-author="" >
            <span class="post-title" title="常用正则表达式">常用正则表达式</span>
            <span class="post-date" title="2021-04-02 00:00:00">2021/04/02</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/03/25/Web%E5%AE%89%E5%85%A8-Nginx%E5%AE%89%E5%85%A8/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="Apache安全">Apache安全</span>
            <span class="post-date" title="2021-03-25 00:00:00">2021/03/25</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/03/19/Web%E5%AE%89%E5%85%A8-LDAP%E6%B3%A8%E5%85%A5/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="LDAP注入">LDAP注入</span>
            <span class="post-date" title="2021-03-19 00:00:00">2021/03/19</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/03/13/Web%E5%AE%89%E5%85%A8-CSR&SSRF/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="CSRF &amp; SSRF">CSRF &amp; SSRF</span>
            <span class="post-date" title="2021-03-13 00:00:00">2021/03/13</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/03/09/Web%E5%AE%89%E5%85%A8-CRLF/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="CLRF">CLRF</span>
            <span class="post-date" title="2021-03-09 00:00:00">2021/03/09</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/03/06/Web%E5%AE%89%E5%85%A8-Apache%E5%AE%89%E5%85%A8/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="Apache安全">Apache安全</span>
            <span class="post-date" title="2021-03-06 00:00:00">2021/03/06</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/03/03/Web%E5%AE%89%E5%85%A8-IIS%E5%AE%89%E5%85%A8/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="IIS安全">IIS安全</span>
            <span class="post-date" title="2021-03-03 00:00:00">2021/03/03</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/02/27/Web%E5%AE%89%E5%85%A8-XSS/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="XSS">XSS</span>
            <span class="post-date" title="2021-02-27 00:00:00">2021/02/27</span>
        </a>
        
        
        <a  class="全部文章 Web安全 "
           href="/2021/02/10/Web%E5%AE%89%E5%85%A8-%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC/"
           data-tag="2021,Web"
           data-author="" >
            <span class="post-title" title="一句话木马">一句话木马</span>
            <span class="post-date" title="2021-02-10 00:00:00">2021/02/10</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2020/02/10/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-VXLAN-04/"
           data-tag="2020"
           data-author="" >
            <span class="post-title" title="虚拟扩展局域网-VXLAN-04">虚拟扩展局域网-VXLAN-04</span>
            <span class="post-date" title="2020-02-10 00:00:00">2020/02/10</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2020/01/30/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-VXLAN-03/"
           data-tag="2020"
           data-author="" >
            <span class="post-title" title="虚拟扩展局域网-VXLAN-03">虚拟扩展局域网-VXLAN-03</span>
            <span class="post-date" title="2020-01-30 00:00:00">2020/01/30</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2020/01/20/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-VXLAN-02/"
           data-tag="2020"
           data-author="" >
            <span class="post-title" title="虚拟扩展局域网-VXLAN-02">虚拟扩展局域网-VXLAN-02</span>
            <span class="post-date" title="2020-01-20 00:00:00">2020/01/20</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2020/01/10/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-VXLAN-01/"
           data-tag="2020"
           data-author="" >
            <span class="post-title" title="虚拟扩展局域网-VXLAN-01">虚拟扩展局域网-VXLAN-01</span>
            <span class="post-date" title="2020-01-10 00:00:00">2020/01/10</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2019/03/01/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-MPLS/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="多协议标签交换—MPLS">多协议标签交换—MPLS</span>
            <span class="post-date" title="2019-03-01 00:00:00">2019/03/01</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2019/02/15/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-DHCP/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="DHCP协议详解">DHCP协议详解</span>
            <span class="post-date" title="2019-02-15 00:00:00">2019/02/15</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2019/02/10/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-OSPF%20v3/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="最短路径优先协议—OSPFv3">最短路径优先协议—OSPFv3</span>
            <span class="post-date" title="2019-02-10 00:00:00">2019/02/10</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2019/02/05/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-OSPF%20v2/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="最短路径优先协议—OSPFv2">最短路径优先协议—OSPFv2</span>
            <span class="post-date" title="2019-02-05 00:00:00">2019/02/05</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2019/01/30/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-BGP/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="边界网关协议—BGP">边界网关协议—BGP</span>
            <span class="post-date" title="2019-01-30 00:00:00">2019/01/30</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2019/01/10/%E8%B7%AF%E7%94%B1%E4%BA%A4%E6%8D%A2-%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="路由策略&amp;策略路由">路由策略&amp;策略路由</span>
            <span class="post-date" title="2019-01-10 00:00:00">2019/01/10</span>
        </a>
        
        
        <a  class="全部文章 数字通信 网络基础 "
           href="/2019/01/10/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80-%E5%8D%8F%E8%AE%AE%E5%B0%81%E8%A3%85/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="Etherenet协议封装">Etherenet协议封装</span>
            <span class="post-date" title="2019-01-10 00:00:00">2019/01/10</span>
        </a>
        
        
        <a  class="全部文章 数字通信 "
           href="/2019/01/01/%E8%99%9A%E6%8B%9F%E5%8C%96-EXSI/"
           data-tag="2019"
           data-author="" >
            <span class="post-title" title="虚拟化-EXSI">虚拟化-EXSI</span>
            <span class="post-date" title="2019-01-01 00:00:00">2019/01/01</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-路由交换-MPLS" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">多协议标签交换—MPLS</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="数字通信">数字通信</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color5">2019</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        <!-- 修改了原始显示，原始显示更新日期为悬浮 -->
        <!-- 
            发布时间 : <time class="date" title='最后更新: 2023-10-22 00:55:14'>2019-03-01 00:00</time>
         -->

        
            发布时间 : 2019-03-01 00:00</time>
        <br>

        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E8%BF%B0"><span class="toc-text">简述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-text">体系结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B"><span class="toc-text">模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MPLS%E5%B0%81%E8%A3%85"><span class="toc-text">MPLS封装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%BD%AC%E5%8F%91"><span class="toc-text">数据转发</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE"><span class="toc-text">标签</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%A0%87%E7%AD%BE"><span class="toc-text">静态标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%A0%87%E7%AD%BE"><span class="toc-text">动态标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LSP%E8%BF%9E%E9%80%9A%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="toc-text">LSP连通性测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LDP"><span class="toc-text">LDP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F"><span class="toc-text">报文格式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#L2-L3-VPN"><span class="toc-text">L2&#x2F;L3 VPN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9FVPN-OptionA%E5%9C%BA%E6%99%AF"><span class="toc-text">跨域VPN OptionA场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9FVPN-OptionB%E5%9C%BA%E6%99%AF"><span class="toc-text">跨域VPN OptionB场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9FVPN-OptionC%E5%9C%BA%E6%99%AF"><span class="toc-text">跨域VPN OptionC场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HoVPN-HVPLS%E5%9C%BA%E6%99%AF"><span class="toc-text">HoVPN&#x2F;HVPLS场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%90%A5%E5%95%86%E7%9A%84%E8%BF%90%E8%90%A5%E5%95%86CSC%EF%BC%88Carriers%E2%80%99-Carrier%EF%BC%89%E5%9C%BA%E6%99%AF"><span class="toc-text">运营商的运营商CSC（Carriers’ Carrier）场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ping-Tracert"><span class="toc-text">Ping&#x2F;Tracert</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MPLS-Ping-Tracert-MPLS-Echo-%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F"><span class="toc-text">MPLS Ping&#x2F;Tracert (MPLS Echo)报文格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F-1"><span class="toc-text">报文格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E6%96%87%E7%A4%BA%E4%BE%8B"><span class="toc-text">报文示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E6%9D%82%E9%A1%B9%E8%AE%B0%E5%BD%95"><span class="toc-text">其它杂项记录</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>MPLS主要运用场景：VPN、流量工程、QOS</p>
<h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p><img src="/./images/MPLS1.png" alt="MPLS图片"></p>
<p>​        1、IP报文进入MPLS网络时，MPLS入口的LER分析IP报文的内容并且为这些IP报文添加合适的标签，所有MPLS网络中的LSR根据标签转发数据。当该IP报文离开MPLS网络时，标签由出口LER弹出。</p>
<p>​        2、IP报文在MPLS网络中经过的路径称为标签交换路径LSP（Label Switched Path）。LSP是一个单向路径，与数据流的方向一致。</p>
<p>​        3、如上图，LSP的入口LER称为入节点（Ingress）；位于LSP中间的LSR称为中间节点（Transit）；LSP的出口LER称为出节点（Egress）。一条LSP可以有0个、1个或多个中间节点，但有且只有一个入节点和一个出节点。</p>
<p>​        3、根据LSP的方向，MPLS报文由Ingress发往Egress，则Ingress是Transit的上游节点，Transit是Ingress的下游节点。同理，Transit是Egress上游节点，Egress是Transit的下游节点。</p>
<h2 id="体系结构"><a href="#体系结构" class="headerlink" title="体系结构"></a>体系结构</h2><p>组成：<font color="#660000">控制平面（Control Plane）</font>和<font color="#660066">转发平面（Forwarding Plane）</font></p>
<p><img src="/./images/MPLS2.png" alt="MPLS图片"></p>
<p><font color="#660000">控制平面</font>：负责产生和维护路由信息以及标签信息。</p>
<p>​        路由信息表RIB（Routing Information Base）：由IP路由协议（IP Routing Protocol）生成，用于选择路由。</p>
<p>​        标签分发协议LDP（Label Distribution Protocol）：负责标签的分配、标签转发信息表的建立、标签交换路径的建立、拆除等工作。</p>
<p>​        标签信息表LIB（Label Information Base）：由标签分发协议生成，用于管理标签信息。</p>
<p><font color="#660066">转发平面</font>：即数据平面（Data Plane），负责普通IP报文的转发以及带MPLS标签报文的转发。</p>
<p>​        转发信息表FIB（Forwarding Information Base）：从RIB提取必要的路由信息生成，负责普通IP报文的转发。</p>
<p>​        标签转发信息表LFIB（Label Forwarding Information Base）：简称标签转发表，由标签分发协议在LSR上建立LFIB，负责带MPLS标签报文的转发。</p>
<h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>**MPLS模型：LER(label edge router)&lt;–&gt;LSR(label switch router)&lt;–&gt;LER(label edge router)**（报文转发路径叫做LSP(label switch patch)）</p>
<p>① LSR（Label Switching Router）：LSR是MPLS的网络的核心交换机或者路由器，它处于MPLS网络的内部。LSR提供标签交换和标签分发功能。</p>
<p>​        【控制单元】运行网络层协议，创建和维护路由表。运行LDP协议进行标签分配和分发，创建和维护标签信息表。</p>
<p>​        【转发单元】标记分组的转发，包括标签交换（出口标记代替入口标签）与标签分组的封装。网络层分组的转发。</p>
<p>② LER（Label Switching Edge Router）：在MPLS的网络边缘，报文由LER进入或离开MPLS网络。它提供标签的映射、标签的移除和标签的分发功能。</p>
<p>​        【控制单元】运行网络层协议，创建和维护路由表。运行LDP协议进行标签分配和分发，创建和维护标签信息表。</p>
<p>​        【转发单元】</p>
<p>​                入口：数据分组到LSP的映射。数据分组加标签封装标签分组。作为标签分组转发到下一个LSR。</p>
<p>​                出口：将标签从分组中删除。作为网络层转发到next hop。入口LER和出口LER均可实现网络分组的转发</p>
<h2 id="MPLS封装"><a href="#MPLS封装" class="headerlink" title="MPLS封装"></a>MPLS封装</h2><p>​    帧        二层头&lt;–&gt;MPLS label&lt;–&gt;IP头<br>​    信源    原有标签基础上新加标签  </p>
<p>​    <img src="/./images/MPLS3.png" alt="MPLS图片">2.5层</p>
<p>标签空间：<br>    0<del>5              特殊标签<br>    16</del>1023     静态LSP和静态CR-LSP<br>    1024+          动态信令</p>
<p>MPSL结构：<br>    控制平面：交换路由信息、标签交换（包含：路由表、路由协议、协议标签）<br>    数据平面：接受IP&#x2F;带标签报文、发送IP&#x2F;带标签报文（包含：标签转发表、ip转发表）</p>
<p>标签操作：<br>    Push：IP报文进入MPLS域时MPLS边界设备在二层头和IP头之间插入标签，或中间设备在MPLS标签栈顶插入新标签（MPLS栈）<br>    Swap：报文在MPLS域内根据标签转发，用下一跳分配标签，替换MPLS报文的栈顶标签<br>    Pop：报文离开MPLS域脱去MPLS标签</p>
<h1 id="数据转发"><a href="#数据转发" class="headerlink" title="数据转发"></a>数据转发</h1><p><strong>转发过程概念：</strong>标签操作类型包括标签压入（Push）、标签交换（Swap）和标签弹出（Pop），它们是标签转发的基本动作。</p>
<p>​      ▪ Push：当IP报文进入MPLS域时，MPLS边界设备在报文二层首部和IP首部之间插入一个新标签；或者MPLS中间设备根据需要，在标签栈顶增加一个新的标签（即标签嵌套封装）。</p>
<p>​      ▪ Swap：当报文在MPLS域内转发时，根据标签转发表，用下一跳分配的标签，替换MPLS报文的栈顶标签。</p>
<p>​      ▪ Pop：当报文离开MPLS域时，将MPLS报文的标签剥掉。</p>
<p>​                在最后一跳节点，标签已经没有使用价值。这种情况下，可以利用倒数第二跳弹出特性PHP（Penultimate Hop Popping），在倒数第二跳节点处将标签弹出，减少最后一跳的负担。最后一跳节点直接进行IP转发或者下一层标签转发。</p>
<p>​                默认情况下，设备支持PHP特性，支持PHP的Egress节点分配给倒数第二跳节点的标签值为3</p>
<p><strong>MPLS基本转发过程</strong> </p>
<p><img src="/./images/MPLS1.png" alt="MPLS图片"></p>
<p>MPLS标签已分发完成，建立了一条LSP，其目的地址为4.4.4.2&#x2F;32。则MPLS基本转发过程如下：</p>
<ol>
<li>Ingress节点收到目的地址为4.4.4.2的IP报文，压入标签Z并转发。</li>
<li>Transit节点收到该标签报文，进行标签交换，将标签Z换成标签Y。</li>
<li>倒数第二跳Transit节点收到带标签Y的报文。因为Egress分给它的标签值为3，所以进行PHP操作，弹出标签Y并转发报文。从倒数第二跳转发给Egress的报文以IP报文形式传输。</li>
<li>Egress节点收到该IP报文，将其转发给目的地4.4.4.2&#x2F;32。</li>
</ol>
<p>MPLS详细转发过程中涉及的相关概念</p>
<p>​      ▪ Tunnel ID</p>
<p>为了给使用隧道的上层应用（如VPN、路由管理）提供统一的接口，系统自动为隧道分配了一个ID，也称为Tunnel ID。该Tunnel ID的长度为32比特，只是本地有效。</p>
<p>​      ▪ NHLFE</p>
<p>下一跳标签转发表项NHLFE（Next Hop Label Forwarding Entry）用于指导MPLS报文的转发。</p>
<p>NHLFE包括：Tunnel ID、出接口、下一跳、出标签、标签操作类型等信息。</p>
<p>FEC到一组NHLFE的映射称为FTN（FEC-to-NHLFE）。通过查看FIB表中Tunnel ID值不为0x0的表项，能够获得FTN的详细信息。FTN只在Ingress存在。</p>
<p>​      ▪ ILM</p>
<p>入标签到一组下一跳标签转发表项的映射称为入标签映射ILM（Incoming Label Map）。</p>
<p>ILM包括：Tunnel ID、入标签、入接口、标签操作类型等信息。</p>
<p>ILM在Transit节点的作用是将标签和NHLFE绑定。通过标签索引ILM表，就相当于使用目的IP地址查询FIB，能够得到所有的标签转发信息。</p>
<p>MPLS转发图例说明</p>
<p><img src="/./images/MPLS2.png" alt="MPLS图片"></p>
<p><strong>①</strong>当IP报文进入MPLS域时，首先查看FIB表，检查目的IP地址对应的Tunnel ID值是否为0x0。</p>
<p>• 如果Tunnel ID值为0x0，则进入正常的IP转发流程。</p>
<p>• 如果Tunnel ID值不为0x0，则进入MPLS转发流程。</p>
<p>在MPLS转发过程中，FIB、ILM和NHLFE表项是通过Tunnel ID关联的。</p>
<p>• Ingress的处理：通过查询FIB表和NHLFE表指导报文的转发。</p>
<ol>
<li>查看FIB表，根据目的IP地址找到对应的Tunnel ID。</li>
<li>根据FIB表的Tunnel ID找到对应的NHLFE表项，将FIB表项和NHLFE表项关联起来。</li>
<li>查看NHLFE表项，可以得到出接口、下一跳、出标签和标签操作类型。</li>
<li>在IP报文中压入出标签，同时处理TTL，然后将封装好的MPLS报文发送给下一跳。</li>
</ol>
<p><strong>②</strong>• Transit的处理：通过查询ILM表和NHLFE表指导MPLS报文的转发。</p>
<ol>
<li>根据MPLS的标签值查看对应的ILM表，可以得到Tunnel ID。</li>
<li>根据ILM表的Tunnel ID找到对应的NHLFE表项。</li>
<li>查看NHLFE表项，可以得到出接口、下一跳、出标签和标签操作类型。</li>
<li>MPLS报文的处理方式根据不同的标签值而不同。</li>
</ol>
<p>• 如果标签值&gt;＝16，则用新标签替换MPLS报文中的旧标签，同时处理TTL，然后将替换完标签的MPLS报文发送给下一跳。</p>
<p>• 如果标签值为3，则直接弹出标签，同时处理TTL，然后进行IP转发或下一层标签转发。</p>
<p><strong>③</strong>• Egress的处理：通过查询ILM表指导MPLS报文的转发或查询路由表指导IP报文转发。</p>
<p>• 如果Egress收到IP报文，则查看路由表，进行IP转发。</p>
<p>• 如果Egress收到MPLS报文，则查看ILM表获得标签操作类型，同时处理TTL。</p>
<p>• 如果标签中的栈底标识S&#x3D;1，表明该标签是栈底标签，直接进行IP转发。</p>
<p>• 如果标签中的栈底标识S&#x3D;0，表明还有下一层标签，继续进行下一层标签转发。</p>
<p>MPLS对TTL的处理模式：MPLS对TTL的处理模式、ICMP响应报文</p>
<p>MPLS标签中包含一个8比特的TTL字段，其含义与IP头中的TTL域相同。MPLS对TTL的处理除了用于防止产生路由环路外，也用于实现Traceroute功能。</p>
<p>RFC3443中定义了两种MPLS对TTL的处理模式：Uniform和Pipe。缺省情况下，MPLS对TTL的处理模式为Uniform。</p>
<p>• Uniform模式</p>
<p>IP报文经过MPLS网络时，在入节点，IP TTL减1映射到MPLS TTL字段，此后报文在MPLS网络中按照标准的TTL处理方式处理。在出节点将MPLS TTL减1后映射到IP TTL字段。</p>
<p>​     Uniform模式下入方向TTL的处理 </p>
<p><img src="/./images/MPLS3.png" alt="MPLS图片"></p>
<p>• Pipe模式</p>
<p>在入节点，IP TTL值减1，MPLS TTL字段为固定值，此后报文在MPLS网络中按照标准的TTL处理方式处理。在出节点会将IP TTL字段的值减1。即IP分组经过MPLS网络时，无论经过多少跳，IP TTL只在入节点和出节点分别减1。</p>
<p>​     Pipe模式下入方向TTL的处理 </p>
<p><img src="/./images/MPLS4.png" alt="MPLS图片"></p>
<p>在MPLS VPN应用中，出于网络安全的考虑，需要隐藏MPLS骨干网络的结构，这种情况下，对于私网报文，Ingress上使用Pipe模式。</p>
<p>ICMP响应报文</p>
<p>在MPLS网络中，当LSR收到TTL为1的含有标签的MPLS报文时，LSR生成ICMP的TTL超时消息。</p>
<p>LSR将TTL超时消息回应给报文发送者的方式有两种：• 如果LSR上存在到达报文发送者的路由，则可以通过IP路由，直接向发送者回应TTL超时消息。</p>
<p>• 如果LSR上不存在到达报文发送者的路由，则ICMP响应报文将按照LSP继续传送，到达LSP出节点后，由Egress节点将该消息返回给发送者。</p>
<p>通常情况下，收到的MPLS报文只带一层标签时，LSR可以采用第一种方式回应TTL超时消息；收到的MPLS报文包含多层标签时，LSR采用第二种方式回应TTL超时消息。</p>
<p>但是，在MPLS VPN中，ASBR（Autonomous System Boundary Router，自治系统边界路由器）和HoVPN组网应用中的SPE（Superstratum PE or Sevice Provider-end PE，上层PE或运营商侧PE），接收到的承载VPN报文的MPLS报文可能只有一层标签，此时，这些设备上并不存在到达报文发送者的路由，则采用第二种方法回应TTL超时消息。</p>
<h1 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h1><p><strong>转发等价类</strong></p>
<p>​        MPLS将具有相同特征的报文归为一类，称为转发等价类FEC（Forwarding Equivalence Class）。属于相同FEC的报文在转发过程中被LSR以相同方式处理。</p>
<p>​        FEC可以根据源地址、目的地址、源端口、目的端口、VPN等要素进行划分。例如，在传统的采用最长匹配算法的IP转发中，到同一条路由的所有报文就是一个转发等价类。</p>
<p>MPLS标签的长度为4个字节。MPLS标签封装在链路层和网络层之间，可以支持任意的链路层协议</p>
<p><img src="/./images/MPLS1.png" alt="MPLS图片"></p>
<p>Label：  20bit，      标签值域。<br>Exp：     3bit，        用于扩展。现在通常用做CoS（Class of Service），当设备阻塞时，优先发送优先级高的报文。<br>S：         1bit，        栈底标识。MPLS支持多层标签，即标签嵌套。S值为1时表明为最底层标签。<br>TTL：     8bit，        和IP报文中的TTL（Time To Live）意义相同。<br>TTL：     8bit，        和IP报文中的TTL（Time To Live）意义相同。</p>
<p>标签动作：<br>        压入（Push）、标签交换（Swap）、标签弹出（Pop&#x2F;out lable 3）、NULL<br>        out lable 3 (pop)弹出顶部标签、out lable NULL弹出标签栈<br>        转发根据顶部标签执行</p>
<p><strong>标签栈</strong></p>
<p><img src="/./images/MPLS2.png" alt="MPLS图片"></p>
<p><strong>标签空间：</strong></p>
<p>0～15：特殊标签。<br>16～1023：静态LSP和静态CR-LSP（Constraint-based Routed Label Switched Path）共享的标签空间。<br>1024及以上：LDP、RSVP-TE（Resource Reservation Protocol-Traffic Engineering）、MP-BGP（MultiProtocol Border Gateway Protocol）等动态信令协议的标签空间。</p>
<p>特殊标签表：值 0~15</p>
<table>
<thead>
<tr>
<th>标签值</th>
<th>含义</th>
<th>解释说明</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>IPv4 Explicit NULL Label</td>
<td>表示该标签必须被弹出（即标签被剥掉），且报文的转发必须基于IPv4。如果出节点分配给倒数第二跳节点的标签值为0，则倒数第二跳LSR需要将值为0的标签正常压入报文标签值顶部，转发给最后一跳。最后一跳发现报文携带的标签值为0，则将标签弹出。</td>
</tr>
<tr>
<td>1</td>
<td>Router Alert Label</td>
<td>只有出现在非栈底时才有效。类似于IP报文的“Router Alert Option”字段，节点收到Router Alert Label时，需要将其送往本地软件模块进一步处理。实际报文转发由下一层标签决定。如果报文需要继续转发，则节点需要将Router Alert Label压回标签栈顶。</td>
</tr>
<tr>
<td>2</td>
<td>IPv6 Explicit NULL Label</td>
<td>表示该标签必须被弹出，且报文的转发必须基于IPv6。如果出节点分配给倒数第二跳节点的标签值为2，则倒数第二跳节点需要将值为2的标签正常压入报文标签值顶部，转发给最后一跳。最后一跳发现报文携带的标签值为2，则直接将标签弹出。</td>
</tr>
<tr>
<td>3</td>
<td>Implicit NULL Label</td>
<td>倒数第二跳LSR进行标签交换时，如果发现交换后的标签值为3，则将标签弹出，并将报文发给最后一跳。最后一跳收到该报文直接进行IP转发或下一层标签转发。</td>
</tr>
<tr>
<td>4～13</td>
<td>保留</td>
<td></td>
</tr>
<tr>
<td>14</td>
<td>OAM Router Alert Label</td>
<td>MPLS OAM（Operation Administration &amp; Maintenance）通过发送OAM报文检测和通告LSP故障。OAM报文使用MPLS承载。OAM报文对于Transit LSR和倒数第二跳LSR（penultimate LSR）是透明的。</td>
</tr>
<tr>
<td>15</td>
<td>保留</td>
<td></td>
</tr>
</tbody></table>
<p>MPLS标签鉴别 MPLS允许与数据链路层与网络层之间（2.5层）</p>
<p>​        MPLS协议通过在报文的链路层报文头中进行标识，使得路由器能够识别MPLS报文。</p>
<p><img src="/./images/MPLS3.png" alt="MPLS图片"></p>
<p><strong>标签分类</strong></p>
<p>LSP的建立–静态：</p>
<p>​        静态LSP是用户通过手工为各个转发等价类分配标签而建立的。由于静态LSP各节点上不能相互感知到整个LSP的情况，因此静态LSP是一个本地的概念。</p>
<p>​        静态LSP不使用标签发布协议，不需要交互控制报文，因此消耗资源比较小，适用于拓扑结构简单并且稳定的小型网络。但通过静态方式分配标签建立的LSP不能根据网络拓扑变化动态调整，需要管理员干预。</p>
<p>​        配置静态LSP时，管理员需要为各LSR手工分配标签，需要遵循的原则是：前一节点出标签的值等于下一个节点入标签的值。</p>
<p>LSP的建立–动态：</p>
<p>​        动态LSP的标签发布协议</p>
<p>​        动态LSP通过标签发布协议动态建立。标签发布协议是MPLS的控制协议（也可称为信令协议），负责FEC的分类、标签的分发以及LSP的建立和维护等一系列操作。</p>
<p>​        动态LSP的基本建立过程：标签由下游LSR分配，按从下游到上游的方向分发。如下图，由下游LSR在IP路由表的基础上进行FEC的划分，并根据FEC分配标签，通告给上游的LSR，以便建立标签转发表和LSP。</p>
<p><img src="/./images/MPLS4.png" alt="MPLS图片"></p>
<p>在MPLS的体系机构中，第一项功能是将整个可能的分组集合划分为转发等价类(FEC: Forwarding Equivalence Class)。可将其看作是一组一相同的方式，通过相同的路径，以相同的转发处理方式转发的IP分组。</p>
<p>转发等价类可能对应于一个目标IP子网，也可能对应于边缘LSR认为有意义的任何数据流。例如，发往特定目标的所有交互式数据流或者IP优先级为特定数值的所有数据流都有可能组成一个FEC。另一个例子是，FEC可以是BGP表的一个子集，包括通过同一个出口点（出口BGP）可以到达所有目标前缀。</p>
<h2 id="静态标签"><a href="#静态标签" class="headerlink" title="静态标签"></a>静态标签</h2><p>静态LSP建立依赖于路由表（路由表中要存在destination的路由，且配置LSP时destination、出接口要与路由表一致）</p>
<p>下一跳不可达，MPLS状态为DOWN</p>
<p>MPLS需要为报文事先分配好标签，建立一条LSP，才能进行报文转发。LSP分为静态LSP和动态LSP两种。</p>
<p>​        静态LSP按照路由表配置，destination和出接口以及标签不能配置错误（destination和出接口配置正确，标签标签写错LSP也能UP</p>
<p><strong>静态LSP的建立</strong></p>
<p>​        静态LSP是用户通过手工为各个转发等价类分配标签而建立的。由于静态LSP各节点上不能相互感知到整个LSP的情况，因此静态LSP是一个本地的概念。</p>
<p>​        静态LSP不使用标签发布协议，不需要交互控制报文，因此消耗资源比较小，适用于拓扑结构简单并且稳定的小型网络。但通过静态方式分配标签建立的LSP不能根据网络拓扑变化动态调整，需要管理员干预。</p>
<h2 id="动态标签"><a href="#动态标签" class="headerlink" title="动态标签"></a>动态标签</h2><p>动态标签分类： LDP、RSVP-TE、MP-BGP</p>
<p>LDP：Label Distribution Protocol标签分配协议，因为它实现简单可靠，逐渐成为MPLS网络中应用最为广泛的标签分配协议之一。</p>
<p>使用udp&#x2F;tcp&#x3D;646端口</p>
<p>LDP协议存在4种类型的LDP消息：</p>
<p>​        发现消息（Discovery messages）               UDP：用于LDP邻居的发现和维持。</p>
<p>​        会话消息（Session messages）                  UDP：用于LDP邻居会话的建立、维持和中止。</p>
<p>​        通告消息（Advertisement messages）       TCP：用于向LDP邻居宣告、创建、改变、删除fec映射标签</p>
<p>​        通知消息（Notification messages）           TCP：用于向LDP邻居通知事件或者错误。</p>
<p><img src="/./images/MPLS1.png" alt="MPLS图片"></p>
<p><img src="/./images/MPLS3.png" alt="MPLS图片"></p>
<p>使用Lsr id建立邻居关系</p>
<p>LDP临接体：本地邻接体使用组播发送hello，远端临接体使用单播发送hello</p>
<p>LDP会话：本地LDP建立会话的两个LSR之间直连、远端LDP会话建立时两个LSR可以直连也可非直连；本地LDP和远端LDP会话可以共存</p>
<p>在物理接口下mpls ldp transport-address interface修改传输地址为本接口地址。抓包报文中没有’传输地址‘字段（即认为源地址为传输地址），项目中使用Lsr id作为传输地址</p>
<p>MPLS标签空间：基于接口、基于帧、基于全局</p>
<p>hello报文&#x2F;keepalive报文15S&#x2F;次、LDP会话保持时长45S</p>
<p>ldp peer依靠hello报文维护、ldp session依靠keepalive报文维护。dis ldp peer下PeerID显示为邻居lsr-id和标签空间</p>
<p>FEC是谁？哪些FEC需要创建LSP？LSP的ingress、transit、egress如何确定？</p>
<p>​        FEC转发等价类（32位主机路由，环回口路由）</p>
<p>lsp-trigger host       </p>
<p>​        默认给非接口直连32位主机路由创建LSP，原因：回环口用于建立LSP隧道（一般使用host）</p>
<p>​        为非主机路由（直连除外）作为transit节点创建LSP</p>
<p>​        为直连非接口主机路由作为egress节点创建LSP</p>
<p>​        为其它主机路由作为ingress、transit节点创建LSP</p>
<p>lsp-trigger all</p>
<p>​        为直连非接口主机路由作为egress界定创建LSP</p>
<p>​        为其它主机路由作为ingress、transit节点创建LSP</p>
<p>​        为直连接口路由作为egress节点创建LSP</p>
<p>​        为非直连非主机路由作为transit、ingress节点创建LSP</p>
<p>dis mpls lsp        IN为NULL则为Ingress节点，不为NULL则为transit。OUT为NULL则为egress</p>
<p><strong>标签分配方式（Label Advertisement Mode）</strong></p>
<p>​        DOD（downstream-on-demand，下游按需标记分配）</p>
<p>​        DU（downstream unsolicited，下游自主标记分配）</p>
<p><img src="/./images/MPLS4.png" alt="MPLS图片"></p>
<table>
<thead>
<tr>
<th>标签发布方式</th>
<th>含义</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>DU</td>
<td>对于一个特定的FEC，LSR无需从上游获得标签请求消息即进行标签分配与分发。</td>
<td>如上图所示，对于目的地址为192.168.1.1&#x2F;32的FEC，下游（Egress）通过标签映射消息主动向上游（Transit）通告自己的主机路由192.168.1.1&#x2F;32的标签。</td>
</tr>
<tr>
<td>DoD</td>
<td>对于一个特定的FEC，LSR获得标签请求消息之后才进行标签分配与分发。</td>
<td>如上图所示，对于目的地址为192.168.1.1&#x2F;32的FEC，上游（Ingress）向下游发送标签请求消息，下游（Egress）收到标签请求消息后，才会向上游发送标签映射消息。</td>
</tr>
</tbody></table>
<p>标签发布方式为DU时，系统默认支持LDP为所有对等体分标签，即每个节点都可以向所有的对等体发送标签映射消息，不区分上下游关系，因为在只给上游对等体分标签情况下，发送标签映射消息的时候，要根据路由信息对会话的上下游进行确认，若路由发生变化，上下游关系倒换，新的下游需要重新给上游节点发送标签映射消息，收敛慢（dis ldp session all查勘所有LDP会话消息，建立不成功的将以‘*’显示）针对华为设备</p>
<p><strong>标签分配控制方式（Label Distribution Control Mode）</strong>标签分配控制方式是指在LSP的建立过程中，LSR分配标签时采用的处理方式。</p>
<p>​        独立标签分配控制方式（Independent）：本地LSR可以自主地分配一个标签绑定到某个FEC，并通告给上游LSR，而无需等待下游的标签。</p>
<p>​        有序标签分配控制方式（Ordered）：对于LSR上某个FEC的标签映射，只有当该LSR已经具有此FEC下一跳的标签映射消息、或者该LSR就是此FEC的出节点时，该LSR才可以向上游发送此FEC的标签映射。</p>
<p><strong>标签分配控制方式和标签发布方式的组合：</strong></p>
<table>
<thead>
<tr>
<th>标签分配控制方式</th>
<th>下游自主方式DU</th>
<th>下游按需方式DoD</th>
</tr>
</thead>
<tbody><tr>
<td>独立标签分配控制方式</td>
<td>DU ＋ Independent：LSR（Transit）无需等待下游（Egress）的标签，就会直接向上游（Ingress）分发标签。</td>
<td>DoD ＋ Independent：发送标签请求的LSR（Ingress）的直连下游（Transit）会直接回应标签，而不必等待来自最终下游（Egress）的标签。</td>
</tr>
<tr>
<td>有序标签分配控制方式</td>
<td>DU ＋ Ordered：LSR（Transit）只有收到下游（Egress）的标签映射消息，才会向上游（Ingress）分发标签。</td>
<td>DoD ＋ Ordered：发送标签请求的LSR（Ingress）的直连下游（Transit）只有收到最终下游（Egress）的标签映射消息，才会向上游（Ingress）分发标签。</td>
</tr>
</tbody></table>
<p><strong>标签保持方式（Label Retention Mode）</strong></p>
<p>标签保持方式是指LSR对收到的、但目前暂时不需要的标签映射的处理方式。</p>
<p>LSR收到的标签映射可能来自下一跳，也可能来自非下一跳。</p>
<p>​        自由标签保持方式（Liberal）</p>
<p>对于从邻居LSR收到的标签映射，无论邻居LSR是不是自己的下一跳都保留。</p>
<p>​        保守标签保持方式（Conservative）</p>
<p>对于从邻居LSR收到的标签映射，只有当邻居LSR是自己的下一跳时才保留。</p>
<p>华为设备支持如下组合方式：</p>
<p>​        下游自主方式（DU）＋ 有序标签分配控制方式（Ordered）＋ 自由标签保持方式（Liberal），该方式为缺省方式。适用于帧模式</p>
<p>​        下游按需方式（DoD）＋ 有序标签分配控制方式（Ordered）＋ 保守标签保持方式（Conservative）。适用于ATM、信源</p>
<p>​        下游自主方式（DU）＋ 独立标签分配控制方式（Independent）＋ 自由标签保持方式（Liberal）。</p>
<p>​        下游按需方式（DoD）＋ 独立标签分配控制方式（Independent）＋ 保守标签保持方式（Conservative）。</p>
<p><strong>普通LDP LSP的建立过程：</strong></p>
<p>LSP的建立过程实际就是将FEC和标签进行绑定，并将这种绑定通告LSP上相邻LSR的过程。如下图所示，下面结合下游自主标签发布方式和有序标签控制方式来说明其主要步骤。</p>
<p><img src="/./images/MPLS5.png" alt="MPLS图片"></p>
<p>​        1、缺省情况下，网络的路由改变时，如果有一个边缘节点（Egress）发现自己的路由表中出现了新的主机路由，并且这一路由不属于任何现有的FEC，则该边缘节点需要为这一路由建立一个新的FEC。</p>
<p>​        2、如果MPLS网络的Egress有可供分配的标签，则为FEC分配标签，并主动向上游发出标签映射消息，标签映射消息中包含分配的标签和绑定的FEC等信息。</p>
<p>​        3、Transit收到标签映射消息后，判断标签映射的发送者（Egress）是否为该FEC的下一跳。若是，则在其标签转发表中增加相应的条目，然后主动向上游LSR发送对于指定FEC的标签映射消息。</p>
<p>​        4、Ingress收到标签映射消息后，判断标签映射的发送者（Transit）是否为该FEC的下一跳。若是，则在标签转发表中增加相应的条目。这时，就完成了LSP的建立，接下来就可以对该FEC对应的数据报文进行标签转发。</p>
<p>上面介绍的是普通LDP LSP的建立，还有一种代理Egress LSP。代理Egress（Proxy Egress）是能够针对非本地路由触发建立LSP的Egress节点，当路由器使能倒数第二跳弹出时，倒数第二跳节点实际上就是一种特殊的代理Egress。一般情况下，代理Egress由配置产生。代理Egress可以应用于网络中有不支持MPLS特性的路由器场景，也可用于解决BGP路由负载分担问题。</p>
<p><strong>代理LDP LSP的建立过程：</strong></p>
<p>​        代理Egress（Proxy Egress）是能够针对非本地路由触发建立LSP的Egress节点，当路由器使能倒数第二跳弹出时，倒数第二跳节点实际上就是一种特殊的代理Egress。一般情况下，代理Egress由配置产生。代理Egress可以应用于网络中有不支持MPLS特性的交换机场景，也可用于解决BGP路由负载分担问题。</p>
<p>​        如图所示，LSR_1、LSR_2和LSR_3处于同一个MPLS域中，LSR_4未使能MPLS LDP（可能由于不支持MPLS LDP特性）。此时，如果将建立LSP的策略配置为所有IGP路由都触发建立LDP LSP，那么LSR_3将成为代理Egress，即在LSR_1、LSR_2和LSR_3仍可以建立到LSR_4的LDP LSP。</p>
<p><img src="/./images/MPLS6.png" alt="MPLS图片"></p>
<p>​        1、将LSR_3执行lsp-trigger all后即可</p>
<p>​        2、使用前缀列表匹配，lsp-trigger ip-prefix xxx</p>
<h2 id="LSP连通性测试"><a href="#LSP连通性测试" class="headerlink" title="LSP连通性测试"></a>LSP连通性测试</h2><p>​		在MPLS网络中，如果通过LSP转发数据失败，负责建立LSP的MPLS控制平面将无法检测到这种错误，加大了网络维护的难度。MPLS Ping&#x2F;MPLS Tracert为用户提供了发现LSP错误、并及时定位失效节点的机制。</p>
<p>​		MPLS Ping主要用于检查LSP的连通性。MPLS Tracert在检查LSP的连通性的同时，还可以分析网络什么地方发生了故障。类似于普通IP的Ping&#x2F;Tracert，MPLS Ping&#x2F;MPLS Tracert使用MPLS回显请求（Echo Request）报文和MPLS回显应答（Echo Reply）报文检测LSP的可用性。这两种消息都以UDP报文格式发送，其中Echo Request的UDP端口号为3503，该端口号只有使能MPLS功能的设备才能识别。</p>
<p>​		MPLS Echo Request中携带需要检测的FEC信息，和其他属于此FEC的报文一样沿LSP发送，从而实现对LSP的检测。MPLS Echo Request报文通过MPLS转发给目的端，而MPLS Echo Reply报文则通过IP转发给源端。另外为了防止LSP断路时Echo Request进行IP转发，从而保证LSP的连通性测试，将Echo Request消息的IP头中目的地址设置为127.0.0.1&#x2F;8（本机环回地址），IP头中的TTL值为1。</p>
<p><img src="/./images/MPLS1.png" alt="MPLS图片"></p>
<p>LSR_1上建立了一条目的地为LSR_4的LSP。从LSR_1对该LSP进行MPLS Ping时的处理如下： </p>
<ol>
<li>LSR_1查找该LSP是否存在（对于TE隧道，查找Tunnel接口是否存在且CR-LSP是否建立成功）。如果不存在，返回错误信息，停止Ping。如果存在，则继续进行以下操作。</li>
<li>LSR_1构造MPLS Echo Request报文，IP头中的目的地址为127.0.0.1&#x2F;8，IP头中的TTL值为1，同时将4.4.4.4填入Echo Request报文中的目的FEC中。然后查找相应的LSP，压入LSP的标签，将报文发送给LSR_2。 </li>
<li>中间节点LSR_2和LSR_3对MPLS Echo Request报文进行普通MPLS转发。如果中间节点MPLS转发失败，则中间节点返回带有错误码的MPLS Echo Reply报文。</li>
<li>当MPLS转发路径无故障，则MPLS Echo Request报文到达LSP的出节点LSR_4。然后检查目的FEC中包含的目的地址4.4.4.4是否为自己的Loopback接口地址，以此来确认LSR_4是该FEC的真正出口后，返回正确的MPLS Echo Reply报文。至此整个MPLS Ping过程结束。</li>
</ol>
<p>MPLS Tracert</p>
<p>如图，从LSR_1对4.4.4.4&#x2F;32进行MPLS Tracert时的处理如下： </p>
<ol>
<li>LSR_1检查LSP是否存在（对于TE隧道，查找Tunnel接口是否存在且CR-LSP是否建立成功）。如果不存在，返回错误信息，停止Tracert，否则继续进行如下处理。</li>
<li>LSR_1构造MPLS Echo Request报文，IP头中的目的地址为127.0.0.1&#x2F;8，同时将4.4.4.4填入MPLS Echo Request报文中的目的FEC中，然后查找相应的LSP，压入LSP的标签并且将MPLS TTL设置为1，将报文发送给LSR_2。此MPLS Echo Request报文中包含Downstream Mapping TLV（用来携带LSP在当前节点的下游信息，主要包括下一跳地址、出标签等）。</li>
<li>LSR_2收到LSR_1发送来的报文后，将MPLS Echo Request中MPLS TTL减1为0后发现TTL超时，然后LSR_2需要检查是否存在该LSP，同时检查报文中Downstream Mapping TLV的下一跳地址、出标签是否正确，如果两项检查都正确，返回正确的MPLS Echo Reply报文，并且报文中必须携带LSR_2本身的包含下一跳和出标签的Downstream Mapping TLV给LSR_1。如果检查有不正确，则返回错误的MPLS Echo Reply报文。</li>
<li>LSR_1收到正确的MPLS Echo Reply报文后再次发送MPLS Echo Request报文，报文的封装方式跟步骤2类似，只是将LSP标签的MPLS TTL设置为2，此时的MPLS Echo Request报文中的Downstream Mapping TLV是从MPLS Echo Reply报文中复制过来的。然后LSR_2收到该报文后进行普通MPLS转发。LSR_3收到此报文，标签的TTL超时，跟步骤3同样的处理方式后返回MPLS Echo Reply报文。</li>
<li>LSR_1收到正确的MPLS Echo Reply报文后重复步骤4把LSP标签的MPLS TTL设置为3，复制Downstream Mapping TLV后发送MPLS Echo Request报文。LSR_2和LSR_3对该报文进行普通MPLS转发。LSR_4收到此报文，重复步骤3处理方式对报文进行处理，同时检查目的FEC中包含的目的IP 4.4.4.4为自己的Loopback接口地址，以此来发现已经是该LSP的出节点，因此返回不带下游信息的MPLS Echo Reply报文，至此整个MPLS Tracert过程结束。</li>
</ol>
<h2 id="LDP"><a href="#LDP" class="headerlink" title="LDP"></a>LDP</h2><p>LDP(Label Distribution Proctocol)标签分发协议，用来在LSR之间建立LDP Session并交换Label&#x2F;FEC映射信息</p>
<p>LDP消息类型（使用TCP&#x2F;UDP）：</p>
<p>​    Discovery message：宣告和维护网络中一个LSR的存在</p>
<p>​    Session message：建立、维护和终止LDP Peers之间的LDP session（connect-init-keepalive-establised 双向）</p>
<p>​    Advertisement message：生成、改变和删除FEC的标签映射</p>
<p>​    Notification message：宣告告警和错误消息</p>
<p>LDP发现机制：</p>
<p>​    LDP基本发现机制：只能发现本地同一条链路LSR邻居（发送hello-message 224.0.0.2(组播)|UDP|646，然后LSR-ID大的一端使用TCP646协商）</p>
<p>​    LDP扩展发现机制：发现远端LSR邻居（发送hello-message 指定IP地址(单播)|UDP|646，然后LSR-ID大的一端使用TCP-646协商）</p>
<h1 id="报文格式"><a href="#报文格式" class="headerlink" title="报文格式"></a>报文格式</h1><p>MPLS  标签（Label）是一个短而定长的、只具有本地意义的标识符，用于唯一标识一个分组所属的FEC。在某些情况下，例如要进行负载分担，对应一个FEC可能会有多个入标签，但是一台路由器上，一个标签只能代表一个FEC。标签与ATM的VPI&#x2F;VCI以及Frame  Relay的DLCI类似，是一种连接标识符。标签长度为4个字节，封装在链路层和网络层之间。这样，标签能够被任意的链路层所支持。标签在分组中的封装位置如下图所示。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>长度</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Label</td>
<td>20比特</td>
<td>标签值字段，用来标识一个FEC。</td>
</tr>
<tr>
<td>EXP</td>
<td>3比特</td>
<td>用于扩展。现在通常用做CoS（Class of Service），其作用与Ethernet802.1p的作用类似。</td>
</tr>
<tr>
<td>S</td>
<td>1比特</td>
<td>MPLS支持多重标签。值为1时表示为最底层标签。</td>
</tr>
<tr>
<td>TTL</td>
<td>8比特</td>
<td>和IP分组中的TTL意义相同，可以用来防止环路。</td>
</tr>
</tbody></table>
<h2 id="L2-L3-VPN"><a href="#L2-L3-VPN" class="headerlink" title="L2&#x2F;L3 VPN"></a>L2&#x2F;L3 VPN</h2><p> MPLS L3VPN报文结构 </p>
<p><img src="/./images/MPLS1.png" alt="MPLS图片"></p>
<p>MPLS L2VPN报文结构 </p>
<p><img src="/./images/MPLS2.png" alt="MPLS图片"></p>
<p><strong>各种公网隧道场景下的MPLS报文携带的标签</strong></p>
<p>在VPN场景下，MPLS报文携带M层私网标签+N层公网隧道标签，M取决于VPN的组网场景（请参见后文），N的取值取决于公网隧道类型。</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>公网隧道标签层数N</th>
</tr>
</thead>
<tbody><tr>
<td>隧道为LDP LSP</td>
<td>1层公网标签</td>
</tr>
<tr>
<td>隧道为static LSP</td>
<td>1层公网标签</td>
</tr>
<tr>
<td>隧道为TE隧道</td>
<td>1层公网标签</td>
</tr>
<tr>
<td>隧道为LDP over TE隧道，报文在TE隧道上传输时</td>
<td>2层公网标签</td>
</tr>
<tr>
<td>TE FRR场景下，报文在bypass隧道上传输时</td>
<td>2层公网标签</td>
</tr>
<tr>
<td>隧道为LDP over TE且部署TE FRR场景下，被保护接口出现故障，业务切换到bypass隧道，报文在bypass隧道上传输时</td>
<td>3层公网标签</td>
</tr>
</tbody></table>
<p> 各种公网隧道场景下的MPLS报文格式 </p>
<p><img src="/./images/MPLS3.png" alt="MPLS图片"></p>
<h2 id="跨域VPN-OptionA场景"><a href="#跨域VPN-OptionA场景" class="headerlink" title="跨域VPN OptionA场景"></a>跨域VPN OptionA场景</h2><p>在各AS域内传递时，报文携带1层私网MPLS标签 + N层公网隧道标签（公网隧道标签参见上文）。</p>
<p>在AS域间传递时，报文不携带MPLS标签。</p>
<p>跨域VPN OptionA场景下的报文结构 </p>
<p><img src="/./images/MPLS4.png" alt="MPLS图片"></p>
<h2 id="跨域VPN-OptionB场景"><a href="#跨域VPN-OptionB场景" class="headerlink" title="跨域VPN OptionB场景"></a>跨域VPN OptionB场景</h2><p>在各AS域内传递时，报文携带1层私网MPLS标签 + N层公网隧道标签（公网隧道标签参见上文）。</p>
<p>在AS域间传递时，报文携带1层私网MPLS标签。</p>
<p>跨域VPN OptionB场景下的报文结构 </p>
<p><img src="/./images/MPLS5.png" alt="MPLS图片"></p>
<h2 id="跨域VPN-OptionC场景"><a href="#跨域VPN-OptionC场景" class="headerlink" title="跨域VPN OptionC场景"></a>跨域VPN OptionC场景</h2><p>• 在首发的AS域内传递时，报文携带1层私网标签 + 1层BGP标签 + N层公网隧道标签• 在AS域间传递时，报文携带1层私网标签+1层BGP标签• 在第2个AS域间传递时，报文携带1层私网标签+ N层公网隧道标签</p>
<p>跨域VPN OptionC场景下的报文结构 </p>
<p><img src="/./images/MPLS6.png" alt="MPLS图片"></p>
<h2 id="HoVPN-HVPLS场景"><a href="#HoVPN-HVPLS场景" class="headerlink" title="HoVPN&#x2F;HVPLS场景"></a>HoVPN&#x2F;HVPLS场景</h2><p>• 核心层传递时，报文携带1层内层标签+N层公网隧道标签• UPE和SPE之间传递时，报文携带1层内层标签</p>
<p>跨域VPN OptionC场景下的报文结构 </p>
<p><img src="/./images/MPLS7.png" alt="MPLS图片"></p>
<h2 id="运营商的运营商CSC（Carriers’-Carrier）场景"><a href="#运营商的运营商CSC（Carriers’-Carrier）场景" class="headerlink" title="运营商的运营商CSC（Carriers’ Carrier）场景"></a>运营商的运营商CSC（Carriers’ Carrier）场景</h2><p>与普通BGP&#x2F;MPLS IP  VPN相比，运营商的运营商的实现关键在于一级运营商CE接入到一级运营商PE这一部分。而二级运营商可能只是普通SP，也可能是BGP&#x2F;MPLS IP  VPN服务提供商。</p>
<p>• 二级运营商是普通SP时，需要在一级运营商CE之间建立BGP会话交换外部路由。二级运营商内部通过IGP或BGP扩散二级运营商的外部路由。二级运营商用户侧PE可以不部署MPLS。• 二级运营商是BGP&#x2F;MPLS IP VPN服务提供商时，其PE也需要运行MPLS，与一级运营商CE之间运行IGP和LDP。二级运营商PE之间通过MP-BGP会话交换外部路由。</p>
<p>运营商的运营商场景(二级运营商为普通SP） </p>
<p><img src="/./images/MPLS8.png" alt="MPLS图片"></p>
<p>运营商的运营商场景(二级运营商也为MPLS VPN  SP） </p>
<p><img src="/./images/MPLS9.png" alt="MPLS图片"></p>
<p>MPLS L2VPN报文示例</p>
<p><img src="/./images/MPLS10.png" alt="MPLS图片"></p>
<h2 id="Ping-Tracert"><a href="#Ping-Tracert" class="headerlink" title="Ping&#x2F;Tracert"></a>Ping&#x2F;Tracert</h2><h1 id="MPLS-Ping-Tracert-MPLS-Echo-报文格式"><a href="#MPLS-Ping-Tracert-MPLS-Echo-报文格式" class="headerlink" title="MPLS Ping&#x2F;Tracert (MPLS Echo)报文格式"></a>MPLS Ping&#x2F;Tracert (MPLS Echo)报文格式</h1><p>MPLS LSP Ping&#x2F;Tracert通过发送MPLS Echo消息实现。MPLS  Echo消息使用IPv4&#x2F;IPv6的UDP协议封装，UDP端口为3503，只有使能MPLS的路由器才能够识别该端口号。</p>
<p>MPLS LSP Traceroute和传统的Traceroute类似，通过连续发送一个TTL步进为1的Echo  Request报文，让LSP沿途的每一个LSR都会收到TTL超时的Echo Request报文，同时回送一个携带下游信息（可选）以及相应返回码的Echo  Reply给发送者。这样发送者就会得到该LSP沿途每一个节点的信息。</p>
<h3 id="报文格式-1"><a href="#报文格式-1" class="headerlink" title="报文格式"></a>报文格式</h3><p>MPLS Echo消息封装在IPv4&#x2F;IPv6的UDP报文中，可能还带有MPLS标签。MPLS Echo消息中，UDP负载的格式如下：</p>
<p><strong>图1</strong> MPLS LSP Echo报文格式 </p>
<p><img src="/./images/MPLS1.png" alt="MPLS图片"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>长度</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Version Number</td>
<td>2字节</td>
<td>标识MPLS Echo的版本号，目前为1。</td>
</tr>
<tr>
<td>Must Be Zero</td>
<td>2字节</td>
<td>必须填全0，接收时忽略。.</td>
</tr>
<tr>
<td>Message Type</td>
<td>1字节</td>
<td>标识该MPLS Echo消息的类型：• 1: MPLS Echo请求消息• 2: MPLS Echo响应消息</td>
</tr>
<tr>
<td>Reply mode</td>
<td>1字节</td>
<td>指示Reply Router采用什么方式回应这个消息：• 1: Do Not Reply• 2: Reply via an IPv4 UDP Packet• 3: Reply via an IPv4 UDP packet with Router Alert</td>
</tr>
<tr>
<td>Return Code</td>
<td>1字节</td>
<td>发送端设置为0，接收端可以设置为如下值之一：• 0: No return code• 1: Malformed Echo Request Received• 2: One Or More of the TLVs Was Not Understood• 3: Replying Router Is an Egress for the FEC at stack-depth <RSC>• 4: Replying Router Has No Mapping for the FEC at stack-depth <RSC>• 5: Downstream Mapping Mismatch • 6: Upstream Interface Index Unknown • 7: Reserved</td>
</tr>
<tr>
<td>Return subcode</td>
<td>1字节</td>
<td>Return Subcode字段包含了标签栈的处理结束的指针。如果Return subcode值为0，标识报文没有携带标签，不需要处理标签。否则，报文携带了标签。</td>
</tr>
<tr>
<td>Sender’s Handle</td>
<td>4字节</td>
<td>发送者句柄，是用来标识一个MPLS Echo的，其值是在应用程序发送一个MPLS Echo Request时随机生成的。单次的LSP Ping操作可以产生多个Echo Request，但是这些Echo Request所包含的Sender’s Handle的值是相同，即单次LSP Ping操作仅能产生一个Sender’s Handle的Echo Request。</td>
</tr>
<tr>
<td>Sequence Number</td>
<td>4字节</td>
<td>序列号，Sequence Number同样是用来标识MPLS Echo的，它是一个进程的概念，进程内有效，可以用来检测丢失的Reply的个数，从而可以对网络进行延时和抖动统计。单次LSP Ping操作可以产生多个Sequence Number，其值一般从零开始逐一递增。</td>
</tr>
<tr>
<td>Timestamp</td>
<td>4字节</td>
<td>时间戳，采用NTP协议的时间格式，包含两部分：收到的时间戳和发送时间戳；可以用来计算报文从一个节点到另一个节点所需要花费的时间。</td>
</tr>
<tr>
<td>TLVs</td>
<td>可变</td>
<td>TLV (Type, Length, Value):• Type &#x3D; 1: Target FEC Stack TLV• Type &#x3D; 2: Downstream mapping TLV• Type &#x3D; 3: PAD TLV• Type &#x3D; 4: Error Code TLV• Type &#x3D; 5: Vendor Enterprise Code TLVLength: Value字段的长度，字节为计数单位。Value:  取决于Type的取值，如果TLV不足4字节的整数倍，需要填充。</td>
</tr>
</tbody></table>
<h3 id="报文示例"><a href="#报文示例" class="headerlink" title="报文示例"></a>报文示例</h3><p>MPLS LSP ping request </p>
<p><img src="/./images/MPLS2.png" alt="MPLS图片"></p>
<p>MPLS LSP ping reply </p>
<p><img src="/./images/MPLS3.png" alt="MPLS图片"></p>
<p>MPLS TE ping request </p>
<p><img src="/./images/MPLS4.png" alt="MPLS图片"></p>
<p>MPLS TE ping reply </p>
<p><img src="/./images/MPLS5.png" alt="MPLS图片"></p>
<p>VCCV ping request </p>
<p><img src="/./images/MPLS6.png" alt="MPLS图片"></p>
<p>VCCV ping request alert </p>
<p><img src="/./images/MPLS7.png" alt="MPLS图片"></p>
<p>VPLS MAC Ping Request </p>
<p> <img src="/./images/MPLS8.png" alt="MPLS图片"></p>
<p>VPLS MAC Ping Reply </p>
<p> <img src="/./images/MPLS9.png" alt="MPLS图片"></p>
<p>VPLS PW Ping Request </p>
<p><img src="/./images/MPLS10.png" alt="MPLS图片"></p>
<p>VPLS Multi-Hop Ping  Request </p>
<p> <img src="/./images/MPLS11.png" alt="MPLS图片"></p>
<p>VPLS Multi-Hop Ping  Reply </p>
<p><img src="/./images/MPLS12.png" alt="MPLS图片"></p>
<h1 id="其它杂项记录"><a href="#其它杂项记录" class="headerlink" title="其它杂项记录"></a>其它杂项记录</h1><p>pop倒数第二跳弹出，减轻倒数第一跳的负担</p>
<p>LSP建立的标签通道可以是单向的</p>
<p>支持打Tag的路由：静态、RIPv2、OSPF、IS-IS。BGP不支持</p>
<p>不适用RT做vpnv4路由的区分</p>
<p>​        1、RT是路由属性，可以有多个，判断vpnv4路由上存在操作复杂</p>
<p>​        3、RT和路由属性、vpnv4前缀放在报文不同地方，涉笔处理不方便</p>
<p>​        4、BGP撤销路由时，不携带属性信息</p>
<p>RD解决同一VPN内路由</p>
<p>公网标签：vpnv4路由在公网的下一跳，由MPLS域中的LDP协议分配</p>
<p>私网标签：方便PE接收私网报文判断属于本段的哪个vpn实例，由接收端PE通过MP-BGP协议发布该私网路由时分配</p>
<p>MPLS-VPN不能解决内网地址段冲突。AS之间运行BGP意义：将IGP路由引入BGP提高可靠性</p>
<p>将IGP路由引入vpnv4路由表需要在BGP下创建实例  ipv4-family vpn instance vpn实例。查看vpn路由时标准子网类不带掩码，如192.158.1.0</p>
<p>ipv4-family vpnv4下，policy vpn-target开启基于RT属性的vpnv4路由过滤（华为默认开启）</p>
<p>​        1、若本路由器没有vpn实例业务接入，则丢弃所有vpnv4路由</p>
<p>​        2、若本路由器存在vpn实例业务接入，则对ert和本端所有vpn实例的iRT做匹配，若ert没有和任何一端vpn实例的irt匹配，则丢弃</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章进行指正，联系邮箱 vou0515@gmail.com </span>
    </div>
</article>







    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2023 closeto
</p>
<p class="footer-entry">Built with Hexo</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
        /* 渲染*/
        function HTMLDecode(text) {
            var temp = document.createElement("div");
            temp.innerHTML = text;
            var output = temp.innerText || temp.textContent;
            temp = null;
            return output;
        }
        if (window.mermaid){
            window.mermaid = null
        }
        $.getScript("//cdn.jsdelivr.net/npm/mermaid@8.4.2/dist/mermaid.min.js", function () {
            var mermaidOptions = JSON.parse(HTMLDecode("{&#34;theme&#34;:&#34;default&#34;,&#34;startOnLoad&#34;:true,&#34;flowchart&#34;:{&#34;useMaxWidth&#34;:false,&#34;htmlLabels&#34;:true}}"))
            if (window.mermaid) {
                mermaid.initialize(mermaidOptions)
                mermaid.contentLoaded()
            }
        })
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 562px;
    }
    .nav.fullscreen {
        margin-left: -562px;
    }
    .nav-left {
        width: 140px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
